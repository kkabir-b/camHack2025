<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DesMusic</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    <script src="https://www.desmos.com/api/v1.11/calculator.js?apiKey=0ff38da4a13b42659a6df0455f0be2bf"></script>

    <script>
        // global calculator
        var calculator;

        async function handleDesmosify() {
            const fileInput = document.getElementById('audio-file');
            const button = document.querySelector('button');

            if (fileInput.files.length === 0) {
                alert('Please select an MP3 file.');
                return;
            }
            
            resetDesmos()
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('audio_file', file);

            button.disabled = true;
            button.textContent = 'Processing...';

            try {
                const response = await fetch('http://127.0.0.1:5000/desmosify', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const data = await response.json();
                
                const expressions = data.latex_expressions.map((latexStr, index) => ({
                    id: `tone_${index + 1}`,
                    latex: latexStr
                }));

                calculator.setExpressions(expressions);
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing the audio.');
            } finally {
                button.disabled = false;
                button.textContent = 'Desmosify!';
            }
        }
        function resetDesmos() {
            calculator.setState({"version":11,"randomSeed":"6a2d3bf7e1315dc2adf403a65882f92b","graph":{"viewport":{"xmin":-9.242724952637445,"ymin":-5.305595401031139,"xmax":7.431404906918839,"ymax":6.238032963277069},"__v12ViewportLatexStash":{"xmin":"-9.242724952637445","xmax":"7.431404906918839","ymin":"-5.305595401031139","ymax":"6.238032963277069"}},"expressions":{"list":[{"type":"expression","id":"fps","color":"#2d70b3","latex":"t=0","slider":{"hardMin":true,"hardMax":true,"min":"0","max":"600"}},{"type":"expression","id":"2","color":"#2d70b3","latex":"p=-7.2","slider":{"hardMin":true,"hardMax":true,"min":"0","max":"1","step":"1"}},{"type":"expression","id":"vocal","color":"#c74440","latex":"v_{vocals} = 1","slider":{"hardMin":true,"hardMax":true,"min":"0","max":"1"}}],"ticker":{"handlerLatex":"\\left\\{p=1:\\left\\{t<600:t\\to t+\\frac{\\operatorname{dt}}{50},p\\to0\\right\\},t\\to0\\right\\}","minStepLatex":"50","open":true}},"includeFunctionParametersInRandomSeed":true,"doNotMigrateMovablePointStyle":true})
            calculator.setExpressions([
            ]);
        }
    </script>
</head>
<body>
    <div id="topbar">
        <h1>DesMix</h1>
    </div> 

    <div id="optionbox">
        <p>Usage: Set p to 1, unmute audio and turn the ticker on to play music.<br>
        Adjust the volumes of vocals, drums, bass and other to your liking!
        </p>
        <label for="audio-file">Select an mp3 file to graph:</label> <br> <input type="file" id="audio-file" accept=".mp3">
    
        <br>
        <button onclick="handleDesmosify()">Desmosify!</button>
        <br>        
    </div>

    <div id="calculator" style="width: 1800px; height: 900px;"></div>

    <script>
        const elt = document.getElementById('calculator');
        calculator = Desmos.GraphingCalculator(elt, [{actions:true}]);
        resetDesmos();
    </script>
</body>
</html>